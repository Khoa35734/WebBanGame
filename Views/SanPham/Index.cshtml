@model IEnumerable<WebBanGame.Models.SanPham>
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery

@{
    ViewData["Title"] = "Index";


    Layout = "~/Views/Shared/_Layout.cshtml";
    var tokens = Antiforgery.GetAndStoreTokens(Context);

}

<head>
    <meta name="request-verification-token" content="@tokens.RequestToken" />

    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>Danh sách sản phẩm</title>
    <link href='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css' rel='stylesheet'>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css' rel='stylesheet'>
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
    <script type='text/javascript' src='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js'></script>
    <style>
        body {
            background: #eee;
        }

        .ratings i {
            font-size: 16px;
            color: red;
        }

        .strike-text {
            color: red;
            text-decoration: none;
        }

        .product-image {
            width: 100%;
        }

        .spec-1 {
            color: #938787;
            font-size: 15px;
        }

        h5 {
            font-weight: 400;
        }

        .para {
            font-size: 16px;
        }
    </style>
</head>

<body>
    <div class="container mt-5 mb-5">
        <div class="d-flex justify-content-center row">
            <div class="col-md-10">
                @{
                    var gameView = Model.Where(x => x.TrangThai == true);
                }
                @foreach (var item in gameView)
                {
                    <div class="row p-2 bg-white border rounded mt-2">
                        <div class="col-md-3 mt-1" style="margin:auto !important;">
                            <img class="img-fluid img-responsive rounded product-image" src="@item.AnhSp" style="width:150px;">
                        </div>
                        <div class="col-md-6 mt-1">
                            <h5>@item.TenSp</h5>
                            <div class="d-flex flex-row">
                                <div class="ratings mr-2">
                                    <i class="fa fa-star"></i>
                                    <i class="fa fa-star"></i>
                                    <i class="fa fa-star"></i>
                                    <i class="fa fa-star"></i>
                                </div>
                                <span>310</span>
                            </div>
                            <div class="mt-1 mb-1 spec-1">
                                <span>Game @item.MaDmNavigation.TenDm</span>
                            </div>
                            <p class="text-justify text-truncate para mb-0">@item.MotaSp<br><br></p>
                        </div>
                        <div class="align-items-center align-content-center col-md-3 border-left mt-1">
                            <div class="d-flex flex-row align-items-center">
                                <h5 class="mr-1" style="font-weight:900;">@item.GiaSp.ToString("#,##0") VNĐ</h5>
                                <span class="strike-text">@item.GiaSp.ToString("#,##0") VNĐ</span>
                            </div>
                            <small class="text-success">Bán chạy</small>
                            <div class="d-flex flex-column mt-4">
                                <a asp-action="Details" asp-route-id="@item.MaSp" class="btn btn-primary btn-sm" st type="button">Xem</a>
                                <button class="btn btn-outline-primary btn-sm mt-2" type="button" onclick="showPurchaseModal(@item.MaSp, '@item.TenSp', @item.GiaSp)">Mua Ngay</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="purchaseModal" tabindex="-1" role="dialog" aria-labelledby="purchaseModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="purchaseModalLabel">Xác nhận mua hàng</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn mua <strong id="productName"></strong> với giá <strong id="productPrice"></strong>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="confirmPurchaseButton">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showPurchaseModal(id, name, price) {
            document.getElementById("productName").textContent = name;
            document.getElementById("productPrice").textContent = price.toLocaleString("vi-VN") + " VNĐ";

            // Gán product ID vào nút xác nhận
            document.getElementById("confirmPurchaseButton").setAttribute("data-product-id", id);

            $('#purchaseModal').modal('show');
        }

        document.getElementById("confirmPurchaseButton").addEventListener("click", function () {
            const productId = this.getAttribute("data-product-id");

            fetch('/Order/Purchase', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('meta[name="request-verification-token"]').getAttribute('content')
                },
                body: JSON.stringify({ productId: productId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Hiển thị thông báo
                        alert(data.message);

                        // Gắn link vào modal
                        const modalBody = document.querySelector("#purchaseModal .modal-body");
                        modalBody.innerHTML = `
                            <p>Mua thành công <strong>${data.productName}</strong>.</p>
                            ${data.downloadLinks.map(link => `<a href="${link}" class="btn btn-success mt-2" target="_blank">Tải xuống sản phẩm</a>`).join("<br>")}
                        `;

                        // Ẩn nút xác nhận
                        document.getElementById("confirmPurchaseButton").style.display = "none";
                    } else {
                        alert("Lỗi: " + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("Có lỗi xảy ra khi xử lý giao dịch.");
                });
        });
    </script>
</body>